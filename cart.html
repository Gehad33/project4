<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Cart - BookStore</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      .fav-title {
        display: inline-block;
        border-bottom: 3px solid #e11d48;
        padding: 2px 8px;
        margin-bottom: 16px;
      }
      .fav-card img {
        height: 220px;
        object-fit: cover;
      }
      .heart-icon {
        cursor: pointer;
        user-select: none;
        transition: transform 0.2s;
      }
      .heart-icon:hover {
        transform: scale(1.08);
      }
    </style>
  </head>
  <body class="bg-light">
    <header class="border-bottom bg-white py-3">
      <div class="container d-flex justify-content-between align-items-center">
        <h4 class="fw-bold text-primary">BookStore</h4>
        <div>
          <span id="userName" class="me-3"></span>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
            Logout
          </button>
        </div>
      </div>
    </header>

    <main class="container py-5">
      <h3 class="text-center mb-4">üõçÔ∏è Your Shopping Cart</h3>
      <div id="cart-items" class="row g-4 justify-content-center"></div>
      <h4 class="text-center mt-4">
        Total Price: <span id="totalPrice">$0.00</span>
      </h4>

      <hr class="my-5" />

      <div class="text-center">
        <h5 class="fav-title">Favorite Items</h5>
      </div>
      <div id="fav-items" class="row g-4 justify-content-center"></div>

      <div class="text-center mt-4">
        <a href="index.html" class="btn btn-primary">Back to Home</a>
      </div>
    </main>

    <script>
      let user = JSON.parse(localStorage.getItem("user"));
      const books = JSON.parse(localStorage.getItem("booksData")) || [];

      const cartContainer = document.getElementById("cart-items");
      const favContainer = document.getElementById("fav-items");
      const totalPriceEl = document.getElementById("totalPrice");

      if (!user) {
        window.location.href = "login.html";
      } else {
        if (!user.cart) user.cart = [];
        if (!user.favorites) user.favorites = [];
        document.getElementById("userName").textContent =
          "Hello, " + user.firstName;
      }

      function saveUser() {
        localStorage.setItem("user", JSON.stringify(user));
      }

      function renderCart() {
        if (!user.cart.length) {
          cartContainer.innerHTML =
            "<p class='text-muted text-center'>Your cart is empty.</p>";
          totalPriceEl.textContent = "$0.00";
          return;
        }

        let total = 0;
        cartContainer.innerHTML = "";

        user.cart.forEach((item) => {
          const product = books.find((b) => b.id === item.id);
          if (!product) return;

          const col = document.createElement("div");
          col.className = "col-md-4";
          col.innerHTML = `
            <div class="card shadow-sm p-3 text-center">
              <img src="${product.img}" class="card-img-top rounded mb-3" alt="${product.title}" style="height:260px;object-fit:cover;">
              <h5>${product.title}</h5>
              <p class="text-muted mb-1">Category: ${product.category}</p>
              <p class="fw-bold mb-2">Price: $${product.price}</p>
              <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                <button class="btn btn-outline-secondary btn-sm qty-btn" data-id="${product.id}" data-action="minus">-</button>
                <span class="fw-bold">${item.quantity}</span>
                <button class="btn btn-outline-secondary btn-sm qty-btn" data-id="${product.id}" data-action="plus">+</button>
              </div>
              <button class="btn btn-danger btn-sm remove-btn" data-id="${product.id}">Remove from Cart</button>
            </div>
          `;
          cartContainer.appendChild(col);
          total += product.price * item.quantity;
        });

        totalPriceEl.textContent = `$${total.toFixed(2)}`;
        saveUser();
      }

      function renderFavorites() {
        favContainer.innerHTML = "";
        if (!user.favorites.length) {
          favContainer.innerHTML =
            "<p class='text-muted text-center'>No favorite items yet.</p>";
          return;
        }

        user.favorites.forEach((fid) => {
          const product = books.find((b) => b.id === fid);
          if (!product) return;

          const col = document.createElement("div");
          col.className = "col-md-3";
          col.innerHTML = `
            <div class="card fav-card shadow-sm p-2">
              <img src="${product.img}" class="card-img-top rounded mb-2" alt="${product.title}">
              <div class="px-2 pb-2 text-center">
                <div class="fw-semibold">${product.title}</div>
                <div class="text-muted small mb-2">Category: ${product.category}</div>
                <div class="d-flex justify-content-center align-items-center gap-3">
                  <button class="btn btn-sm btn-dark add-from-fav" data-id="${product.id}">Add to Cart</button>
                  <i class="bi bi-heart-fill text-danger fs-5 heart-icon toggle-fav" title="Remove from favorites" data-id="${product.id}"></i>
                </div>
              </div>
            </div>
          `;
          favContainer.appendChild(col);
        });
      }

      // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©
      document.addEventListener("click", (e) => {
        // ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÉŸÖŸäÿ©
        if (e.target.classList.contains("qty-btn")) {
          const id = Number(e.target.dataset.id);
          const action = e.target.dataset.action;
          const item = user.cart.find((i) => i.id === id);
          if (!item) return;
          if (action === "plus") item.quantity++;
          if (action === "minus" && item.quantity > 1) item.quantity--;
          saveUser();
          renderCart();
        }

        // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©
        if (e.target.classList.contains("remove-btn")) {
          const id = Number(e.target.dataset.id);
          user.cart = user.cart.filter((i) => i.id !== id);
          saveUser();
          renderCart();
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©
        if (e.target.classList.contains("add-from-fav")) {
          const id = Number(e.target.dataset.id);
          const inCart = user.cart.find((i) => i.id === id);
          if (inCart) inCart.quantity++;
          else user.cart.push({ id, quantity: 1 });
          saveUser();
          renderCart();
        }

        // ‚úÖ ŸÇŸÑÿ®: ÿ≠ÿ∞ŸÅ/ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ÿØÿßÿÆŸÑ cart.html
        if (e.target.classList.contains("toggle-fav")) {
          const id = Number(e.target.dataset.id);
          const idx = user.favorites.indexOf(id);
          if (idx > -1) user.favorites.splice(idx, 1);
          else user.favorites.push(id);
          saveUser();
          renderFavorites();
        }

        // ÿÆÿ±Ÿàÿ¨
        if (e.target.id === "logoutBtn") {
          localStorage.removeItem("user");
          window.location.href = "login.html";
        }
      });

      // ÿ£ŸàŸÑ ÿ™ÿ≠ŸÖŸäŸÑ
      renderCart();
      renderFavorites();
    </script>
  </body>
</html>
